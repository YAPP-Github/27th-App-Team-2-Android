name: Discord PR Review

on:
  pull_request_review:
    types: [ submitted ]
  issue_comment:
    types: [ created ]

jobs:
  notify:
    if: |
      github.actor != 'coderabbitai[bot]' &&
      github.actor != 'coderabbitai' &&
      (github.event_name != 'issue_comment' || github.event.issue.pull_request)
    runs-on: ubuntu-latest

    steps:
      - name: Send PR activity to Discord (Embed)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          EVENT="$GITHUB_EVENT_NAME"
          REPO=$(jq -r '.repository.full_name' "$GITHUB_EVENT_PATH")

          truncate_lines () {
           # usage: truncate_lines "$text" 4
           local text="$1"
           local max="$2"
           echo "$text" | awk -v max="$max" 'NR<=max {print} NR==max {exit}'
          }

          truncate_chars () {
           local s="$1"
           local n="$2"
           if [ "${#s}" -gt "$n" ]; then
           echo "${s:0:$n}â€¦"
           else
           echo "$s"
           fi
          }

          quote_block () {
           # ê° ì¤„ì„ "> "ë¡œ ê°ì‹¸ì„œ Discord ì¸ìš©ë¬¸ ë§Œë“¤ê¸°
           # usage: quote_block "$text"
           echo "$1" | sed 's/^/> /'
          }

          TITLE=""
          DESC=""
          URL=""
          COLOR=7506394
          TIMESTAMP=""

          if [ "$EVENT" = "pull_request_review" ]; then
           PR_NUMBER=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")
           PR_TITLE=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
           PR_URL=$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")

           REVIEWER=$(jq -r '.review.user.login' "$GITHUB_EVENT_PATH")
           STATE=$(jq -r '.review.state' "$GITHUB_EVENT_PATH")
           REVIEW_BODY=$(jq -r '.review.body // ""' "$GITHUB_EVENT_PATH")

           REVIEW_ID=$(jq -r '.review.id' "$GITHUB_EVENT_PATH")
           TIMESTAMP=$(jq -r '.review.submitted_at // empty' "$GITHUB_EVENT_PATH")

           # stateë³„ ì»¬ëŸ¬
           case "$STATE" in
           approved|APPROVED) COLOR=5763719 ;;
           changes_requested|CHANGES_REQUESTED) COLOR=15548997 ;;
           commented|COMMENTED) COLOR=3447003 ;;
           dismissed|DISMISSED) COLOR=9807270 ;;
           *) COLOR=7506394 ;;
           esac

           # âœ… íƒ€ì´í‹€: 2ì¤„ (ìƒíƒœ + PRì •ë³´)
           TITLE=$(printf "ðŸ“ PR Review Â· %s\n[#%s] â€” â€œ%sâ€" "$STATE" "$PR_NUMBER" "$PR_TITLE")

           # ë¦¬ë·° ë³¸ë¬¸ 2~4ì¤„ë§Œ (ì—†ìœ¼ë©´ (ë³¸ë¬¸ ì—†ìŒ))
           if [ -z "$REVIEW_BODY" ] || [ "$REVIEW_BODY" = "null" ]; then
           REVIEW_SNIP="(ë³¸ë¬¸ ì—†ìŒ)"
           else
           REVIEW_SNIP=$(truncate_lines "$REVIEW_BODY" 4)
           fi

           # ì¸ë¼ì¸ ì½”ë©˜íŠ¸ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 10ê°œ)
           COMMENTS_JSON=$(curl -sS -L \
           -H "Accept: application/vnd.github+json" \
           -H "Authorization: Bearer $GITHUB_TOKEN" \
           -H "X-GitHub-Api-Version: 2022-11-28" \
           "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews/$REVIEW_ID/comments?per_page=100")

           INLINE_LINES=$(echo "$COMMENTS_JSON" | jq -r '
           if type=="array" and length>0 then
            .[:10] | map(
            "â€¢ " + .path + " â€” â€œ" + (.body | gsub("\r";"") | split("\n")[0]) + "â€"
            ) | join("\n")
           else
            ""
           end
           ')

           # Description êµ¬ì„±
           DESC=$(printf "Reviewer: %s\n\n%s" "$REVIEWER" "$REVIEW_SNIP")

           if [ -n "$INLINE_LINES" ]; then
           DESC=$(printf "%s\n\nInline Comments\n%s" "$DESC" "$INLINE_LINES")
           fi

           DESC=$(truncate_chars "$DESC" 3800)

           URL="$PR_URL"

          elif [ "$EVENT" = "issue_comment" ]; then
           PR_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
           PR_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
           ISSUE_URL=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")

           COMMENTER=$(jq -r '.comment.user.login' "$GITHUB_EVENT_PATH")
           COMMENT_BODY=$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")
           COMMENT_URL=$(jq -r '.comment.html_url // empty' "$GITHUB_EVENT_PATH")
           TIMESTAMP=$(jq -r '.comment.created_at // empty' "$GITHUB_EVENT_PATH")

           COLOR=15105570

           # âœ… íƒ€ì´í‹€: 2ì¤„ (íƒ€ìž… + PRì •ë³´)
           TITLE=$(printf "ðŸ’¬ PR Comment\n[#%s] â€” â€œ%sâ€" "$PR_NUMBER" "$PR_TITLE")

           if [ -z "$COMMENT_BODY" ] || [ "$COMMENT_BODY" = "null" ]; then
           COMMENT_BODY="(ë³¸ë¬¸ ì—†ìŒ)"
           fi

           # âœ… ëŒ“ê¸€ ë³¸ë¬¸ì€ ì¸ìš©ë¬¸ ì²˜ë¦¬(> )
           QUOTED=$(quote_block "$COMMENT_BODY")

           DESC=$(printf "Commenter: %s\n\n%s" "$COMMENTER" "$QUOTED")
           DESC=$(truncate_chars "$DESC" 3800)

           # ë§í¬ëŠ” PR(ì´ìŠˆ)ë¡œë§Œ (Open Comment ì œê±°)
           URL="$ISSUE_URL"

          else
           exit 0
          fi

          payload=$(jq -n \
           --arg username "ë„¤í‚¤ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ë´‡" \
           --arg avatar "https://i.ifh.cc/PbdkGM.jpg" \
           --arg title "$TITLE" \
           --arg url "$URL" \
           --arg desc "$DESC" \
           --arg ts "$TIMESTAMP" \
           --argjson color "$COLOR" \
           '{
           username: $username,
           avatar_url: $avatar,
           embeds: [
            {
            title: $title,
            url: $url,
            description: $desc,
            color: $color
            }
           ]
           }
           | (if ($ts|length) > 0 then .embeds[0].timestamp = $ts else . end)
           ')

          resp=$(curl -sS -X POST -H "Content-Type: application/json" -d "$payload" \
           -w "\nHTTP_STATUS:%{http_code}\n" \
           "$DISCORD_WEBHOOK_URL" || true)

          echo "$resp"

          status=$(echo "$resp" | sed -n 's/HTTP_STATUS://p')
          if [ -z "$status" ] || [ "$status" -ge 400 ]; then
           echo "Discord webhook failed"
           exit 1
          fi

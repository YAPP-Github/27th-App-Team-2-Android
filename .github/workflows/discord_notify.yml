name: Discord PR Review

on:
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  notify_review:
    if: ${{ github.actor != 'coderabbitai[bot]' && github.actor != 'coderabbitai' }}
    runs-on: ubuntu-latest

    steps:
      - name: Send PR review comment/review to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}

          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_URL: ${{ github.event.comment.html_url }}

          REVIEW_AUTHOR: ${{ github.event.review.user.login }}
          REVIEW_BODY: ${{ github.event.review.body }}
          REVIEW_URL: ${{ github.event.review.html_url }}
        run: |
          set -e

          if [ "$EVENT_NAME" = "pull_request_review_comment" ]; then
            AUTHOR="$COMMENT_AUTHOR"
            BODY="$COMMENT_BODY"
            LINK="$COMMENT_URL"
          else
            AUTHOR="$REVIEW_AUTHOR"
            BODY="$REVIEW_BODY"
            LINK="$REVIEW_URL"
          fi

          # ë§í¬ê°€ ë¹„ë©´ PR ë§í¬ë¡œ fallback
          if [ -z "$LINK" ]; then
            LINK="$PR_URL"
          fi

          # âœ… ë©€í‹°ë¼ì¸ ë¬¸ìžì—´(ë¬¸ì œ ì›ì¸) ì œê±°: printfë¡œ ì•ˆì „í•˜ê²Œ ì¡°ë¦½
          msg=$(printf "%s\n%s\n%s\n%s\n%s\n\n%s\n" \
            "ðŸ“ PR ë¦¬ë·°" \
            "- PR: ${PR_TITLE}" \
            "- ìž‘ì„±ìž: ${AUTHOR}" \
            "- ë³¸ë¬¸:" \
            "${BODY}" \
            "ðŸ”— ${LINK}"
          )

          payload=$(jq -n --arg content "$msg" '{content: $content}')
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" > /dev/null

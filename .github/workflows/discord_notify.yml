name: Discord PR Review

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  notify:
    if: |
      github.actor != 'coderabbitai[bot]' &&
      github.actor != 'coderabbitai' &&
      (github.event_name != 'issue_comment' || github.event.issue.pull_request)
    runs-on: ubuntu-latest

    steps:
      - name: Send PR activity to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          EVENT="$GITHUB_EVENT_NAME"
          REPO=$(jq -r '.repository.full_name' "$GITHUB_EVENT_PATH")

          PR_TITLE=""
          AUTHOR=""
          BODY=""
          TITLE=""

          if [ "$EVENT" = "pull_request_review" ]; then
            PR_TITLE=$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")
            AUTHOR=$(jq -r '.review.user.login' "$GITHUB_EVENT_PATH")
            STATE=$(jq -r '.review.state' "$GITHUB_EVENT_PATH")
            REVIEW_BODY=$(jq -r '.review.body // ""' "$GITHUB_EVENT_PATH")

            PR_NUMBER=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")
            REVIEW_ID=$(jq -r '.review.id' "$GITHUB_EVENT_PATH")

            # ì´ ë¦¬ë·°ì— í¬í•¨ëœ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë“¤ì„ ê°€ì ¸ì™€ì„œ ë³¸ë¬¸ì— í•©ì¹˜ê¸°
            COMMENTS_JSON=$(curl -sS -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews/$REVIEW_ID/comments?per_page=100")

            COMMENTS=$(echo "$COMMENTS_JSON" | jq -r '
              if type=="array" and length>0 then
                .[] | "- [\(.path)] \(.body | gsub("\r";""))"
              else
                ""
              end
            ')

            BODY="$REVIEW_BODY"
            if [ -n "$COMMENTS" ]; then
              if [ -n "$BODY" ]; then
                BODY="$BODY\n\nðŸ’¬ ì¸ë¼ì¸ ì½”ë©˜íŠ¸:\n$COMMENTS"
              else
                BODY="ðŸ’¬ ì¸ë¼ì¸ ì½”ë©˜íŠ¸:\n$COMMENTS"
              fi
            fi

            if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
              BODY="(ë³¸ë¬¸ ì—†ìŒ)"
            fi

            TITLE="ðŸ“ PR ë¦¬ë·° (${STATE})"

          elif [ "$EVENT" = "issue_comment" ]; then
            # PR Conversation ëŒ“ê¸€ (issue_commentì§€ë§Œ PRë§Œ í•„í„°ë§ë¨)
            PR_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
            AUTHOR=$(jq -r '.comment.user.login' "$GITHUB_EVENT_PATH")
            BODY=$(jq -r '.comment.body // ""' "$GITHUB_EVENT_PATH")

            if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
              BODY="(ë³¸ë¬¸ ì—†ìŒ)"
            fi

            TITLE="ðŸ’¬ PR ëŒ“ê¸€"

          else
            exit 0
          fi

          msg=$(printf "%s\n- PR: %s\n- ìž‘ì„±ìž: %s\n- ë³¸ë¬¸:\n%s\n" \
            "$TITLE" "$PR_TITLE" "$AUTHOR" "$BODY"
          )

          # Discord 2000ìž ì œí•œ ëŒ€ë¹„
          msg=$(echo "$msg" | head -c 1800)

          payload=$(jq -n --arg content "$msg" '{content: $content}')
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" > /dev/null

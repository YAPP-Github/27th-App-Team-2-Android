name: Discord PR Review

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify_review:
    if: ${{ github.actor != 'coderabbitai[bot]' && github.actor != 'coderabbitai' }}
    runs-on: ubuntu-latest

    steps:
      - name: Send PR review to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}

          REVIEW_AUTHOR: ${{ github.event.review.user.login }}
          REVIEW_BODY: ${{ github.event.review.body }}
          REVIEW_URL: ${{ github.event.review.html_url }}
          REVIEW_STATE: ${{ github.event.review.state }}
        run: |
          set -e

          AUTHOR="$REVIEW_AUTHOR"
          BODY="$REVIEW_BODY"
          LINK="$REVIEW_URL"
          STATE="$REVIEW_STATE"

          # ë§í¬ê°€ ë¹„ë©´ PR ë§í¬ë¡œ fallback
          if [ -z "$LINK" ]; then
            LINK="$PR_URL"
          fi

          # ìƒíƒœ í‘œì‹œ(approved/changes_requested/commented)
          msg=$(printf "%s\n%s\n%s\n%s\n\n%s\n" \
            "ðŸ“ PR ë¦¬ë·° (${STATE})" \
            "- PR: ${PR_TITLE}" \
            "- ìž‘ì„±ìž: ${AUTHOR}" \
            "- ë³¸ë¬¸: ${BODY}" \
            "ðŸ”— ${LINK}"
          )

          payload=$(jq -n --arg content "$msg" '{content: $content}')
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" > /dev/null
